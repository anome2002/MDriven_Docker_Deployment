services:
  mdriven-server:
    build:
      context: .
      dockerfile: MDrivenServer.Dockerfile
    container_name: mdriven-server
    ports:
      - "5010:5010"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5010/"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s
    environment:
      - ASPNETCORE_URLS=http://+:5010
      - ASPNETCORE_ENVIRONMENT=Development
      - DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=false
    volumes:
      - ./data/server:/app/Data
      - ./data/keys/server:/root/.aspnet/DataProtection-Keys
    networks:
      - mdriven-net
    restart: unless-stopped

  mdriven-turnkey:
    build:
      context: .
      dockerfile: MDrivenTurnkey.Dockerfile
    container_name: mdriven-turnkey
    ports:
      - "5050:5050"
    environment:
      - ASPNETCORE_URLS=http://+:5050
      - ASPNETCORE_ENVIRONMENT=Development
      - DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=false
      - MDrivenServerUrl=http://mdriven-server:5010
      - TURNKEY_MDRIVEN_SERVER_URL=http://mdriven-server:5010
    depends_on:
      mdriven-server:
        condition: service_healthy
    volumes:
      - ./turnkey-settings:/app/App_Data
      - ./data/keys/turnkey:/root/.aspnet/DataProtection-Keys
    networks:
      - mdriven-net
    restart: unless-stopped

networks:
  mdriven-net:
    driver: bridge
